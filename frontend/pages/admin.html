<div id="wrapper">
    <table>
        <tr>
            <th>ID</th>
            <th>Email</th>
            <th>Date</th>
        </tr>
    </table>
    <h2 id="error"></h2>
    <div>
        <h1>Search</h1>
        <input type="text" id="search-bar">
    </div>

    <div>
        <h1>Sort by</h1>
        <button id="sort-date">By Date</button>
        <button id="sort-name">By Name</button>
    </div>


    <div class="hosts">
        <h1>Hosts</h1>
        <button id="all_emails">All emails</button>
    </div>
    
</div>


<script>

let email_list = {}
let search_result_emails = {}

function render_emails(emails) {
    $('table tr.row').remove()
    emails.forEach(email => {
        $('table tr:last').after(`
            <tr class="row">
                <td id='id'>${email.id}</td>
                <td>${email.email}</td>
                <td>${email.date}</td>
            </tr>
        `)
    })

    add_delete_to_emails()
}

function set_error_message(message) {
    $('h2#error').html(message)
}

function add_listener_to_host_buttons() {
    $(".host-button").each((index, element) => {
        $(element).click(() => {
            $.ajax({
                type: 'POST',
                url: '../sorted_by_host',
                data: { host: $(element).text(), emails: search_result_emails.length === undefined ? email_list : search_result_emails},
                success: (response) => {
                    console.log(response)
                    if(response.length < 1)
                    {
                        set_error_message("No such emails")
                    }
                    else{
                        set_error_message("")
                        render_emails(response)
                    }
                }
            })
        })
    })
}

function add_delete_to_emails() {
    $("table tr.row").each((index, row) => {
        $(row).dblclick((event) => {
            $.ajax({
                type: "POST",
                url: "../delete_email",
                data: {id: event.target.parentNode.childNodes[1].innerHTML},
                success: (response) => {
                    alert("Email deleted!")
                    get_emails();
                }
            })
        })
    })
}

function get_emails() {
    // Get emails sorted by date ASC
    $.ajax({
        type: 'GET',
        url: '../get_email_list',
        success: (response) => {
            email_list = response
            render_emails(response)
        }
    })
}

get_emails()

// Get Hosts
$.ajax({
    type: 'GET',
    url: '../get_host_list',
    success: (response)=>{
        response.forEach(host => {
            $('.hosts h1').after(`
                <button class="host-button">${ host }</button>
            `)
        })
        add_listener_to_host_buttons();
    }
})


$('#sort-date').click(()=>{
    $.ajax({
        type: 'POST',
        url: '../sorted_by_date',
        data: {emails: search_result_emails.length === undefined ? email_list : search_result_emails},
        success: (response)=>{ render_emails(response) }
    })
})

$('#sort-name').click(()=>{
    $.ajax({
        type: 'POST',
        url: '../sorted_by_name',
        data: { emails: search_result_emails.length === undefined ? email_list : search_result_emails },
        success: (response)=>{ render_emails(response)}
    })
})

$('#search-bar').keyup(() => {
    if(!$('#search-bar').val()){
        get_emails()
        search_result_emails = {}
    }
    else{
        $.ajax({
            type: 'POST',
            url: '../search_email',
            data: { input: $('#search-bar').val(), emails: email_list },
            success: (response) => {
                search_result_emails = response
                render_emails(response)
            }
        })
    }
})

$("#all_emails").click(()=>{
    get_emails()
    search_result_emails = {}
})

</script>

<style>
    #wrapper {
        display: flex;
        justify-content: center;
        flex-direction: column;
        gap: 10px;
    }

    table, tr, th,td {
        border: 1px solid black;
    }

    #error {
        color: red;
    }
</style>